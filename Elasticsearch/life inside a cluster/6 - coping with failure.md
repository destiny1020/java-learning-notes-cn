## 应对失败 ##

我们说过ES能够应对节点失败的情况，所以让我们试一试。如果我们杀死了第一个节点，那么此时的节点会变成这样：

![](http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/images/02-06_node_failure.png)

被杀死的节点是主节点(Master Node)。一个集群中必须有一个主节点来保证集群能够正常工作，所以第一件事就是剩下的节点会选出一个新的主节点：比方说节点2。

当我们杀死节点1的时候，同时也丢失了主分片1和主分片2，当缺少了主分片的时候索引是不能正常工作的。此时如果检查集群的健康状态，我们会毫无疑问的得到一个`red`：不是所有的主分片都处于活动状态！

幸运的是，丢失的两个主分片的副本分片完好无损的存在于其它的节点上，所以被选为主节点的节点2首先需要做的就是提升节点2和节点3中的相应副本分片，让它们成为主分片。此时集群的状态就会变成`yellow`：所有的主分片又处于活动状态了。对于分片的提升是会立即启动的，就像扳动开关那样。

那么我们的集群为什么是`yellow`，而不是`green`？我们有3个主分片，但是我们指定了每个主分片需要有2个副本分片，但是当前我们只能分配1个副本分片(译注：因为此时我们只有两个节点，相同数据不能同时存储于一个节点上)。这组织了集群的状态变为`green`，但是这里我们并不需要过分担心：假设我们杀死了节点2，应用还是能够在不丢失数据的情况下继续运行，因为节点3还是保存了每个分片的拷贝。

如果我们重启节点1，此时集群又能够对尚未分配的副本分片进行分配了，因此就恢复到了这种组织结构：

![](http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/images/02-05_replicas.png)

如果节点1中仍然存在之前的分片，那么它会尝试继续使用它们，只不过需要从对应的主分片中将最新的变化数据拷贝回来。

现在你应该对ES如何利用分片来实现水平扩展和如何保证数据安全有所了解了。在后面我们还会介绍关于分片的更多细节。





