## 文档的创建，索引和删除 ##

创建，索引和删除的请求都是写操作(Write Operations)，它们都应该首先在主要分片(Primary Shard)上成功完成，然后才能被拷贝关联的副本分片(Replica Shard)上。

![](http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/images/04-02_write.png)

这个过程如上图所示。下面我们列举出图中用来完成创建，索引和删除文档的每个步骤：

1. 客户端(Client)向节点1发送了一个用于创建，索引或是删除的请求。
2. 节点使用该文档的_id字段来决定了它应该属于分片0。因此请求会被转发到节点3，因为分片0的主要分片目前被分配在节点3上。
3. 节点3会在文档对应的主要分片上执行这个请求。如果执行成功了，那么它会将该请求并行地转发到对应副本分片所在的节点1和节点2上。一旦所有的副本分片都成功完成了该请求，那么节点3就会向请求节点(Requesting Node)报告执行成功，然后节点3就能够向客户端发送一个请求执行成功的响应了。

当客户端接收到了执行成功的响应时，在主要分片和其关联的所有副本分片中，发送的文档已经被成功更新了。至此，你的修改就完成了。

在这个过程中还存在一些可选的参数用来对此过程进行调整，可能地如以牺牲数据安全的代价来增加性能。因为ES本身已经足够快了，所以这些可选参数很少被使用，但是为了完整性还是会对它们进行解释：

### replication ###
`replication`的默认值是`sync`。它会导致主要分片将等待副本分片上的执行成功响应，然后才会将执行成功响应发送到请求节点。
如果你将`replication`设置成`async`，那么它会导致成功响应会在请求在主要分片上成功执行后就会被发送到客户端。它仍然会将请求转发到副本分片所在的节点上，只是你将无法得知请求在副本分片上是否能成功执行。
提到这个选项的目的是为了让你不要使用它。默认的`sync`值能够让ES处理各种系统中的数据压力。而使用了`async`可能会因为发送了过多无需等待其完成的请求而让ES处于过载的状态。

### consistency ###
默认情况下，主要分片需要通过仲裁(Quorum)，即确认大部分分片拷贝(分片拷贝可以使主要分片或者副本分片，两者均可)有效时，才会发起一个写操作。这样做的目的是为了防止将数据写入到网络中"错误的一侧(Wrong Side)"。仲裁的定义如下：

> int( (primary + number_of_replicas) / 2 ) + 1

`consistency`的值可以是`one`(仅主要分片)，`all`(主要分片和所有副本分片)，或者是默认的`quorum` - 大部分分片拷贝。

注意`number_of_replicas`是指定在索引设置中的副本分片的数量，不是当前处于活动状态的副本分片数量。如果你在索引中指定了有3个副本分片的话，那么`quorum`的值就是：

> int( (primary + 3 replicas) / 2 ) + 1 = 3

那么当只启动了两个节点时，那么就无法满足`quorum`，从而导致无法索引或者删除任何文档。

### timeout ###
如果没有足够的分片拷贝会如何呢？ES会等待，希望有更多的分片会出现。默认它会等待1分钟。如果需要可以将这个时间设置的短一些：100表示的是100毫秒，30s表示的是30秒。

**NOTE**
一个新的索引默认会有1个副本分片，那么为了满足`quorum`则需要有两个活动的分片拷贝。但是，当ES运行在一个单一节点的集群上时，这些默认设置会阻止用户做任何有用的操作(比如索引等写操作)。为了防止这个问题，只有当`number_of_replicas`大于1时，`quorum`才需要被满足。



